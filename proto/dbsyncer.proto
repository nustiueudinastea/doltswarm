syntax = "proto3";

option go_package = "github.com/nustiueudinastea/doltswarm/proto";

package proto;

import "google/protobuf/timestamp.proto";

service DBSyncer {
  // Commit advertisement with HLC
  rpc AdvertiseCommit (AdvertiseCommitRequest) returns (AdvertiseCommitResponse) {}

  // Request commits since a given HLC (for recovery)
  rpc RequestCommitsSince (RequestCommitsSinceRequest) returns (RequestCommitsSinceResponse) {}
}

// HLC timestamp
message HLCTimestamp {
  int64 wall = 1;
  int32 logical = 2;
  string peer_id = 3;
}

// Commit advertisement with HLC identity
message AdvertiseCommitRequest {
  string peer_id = 1;
  HLCTimestamp hlc = 2;
  string content_hash = 3;
  string commit_hash = 4;  // Hash on sender's main
  string message = 5;
  string author = 6;
  string email = 7;
  google.protobuf.Timestamp date = 8;
  string signature = 9;    // Signature over metadata (authoritative)
}

message AdvertiseCommitResponse {
  bool accepted = 1;
}

// Request commits since a given HLC (for missing ads recovery)
message RequestCommitsSinceRequest {
  HLCTimestamp since_hlc = 1;
}

message RequestCommitsSinceResponse {
  repeated AdvertiseCommitRequest commits = 1;
}
